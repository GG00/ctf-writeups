# mayday (crypto 150)

這是先前跟著隊友作為亂入隊伍，去打 TW-edu CTF 2015 （台大、台科大、中央三校資安實務期末考）的小小紀錄XD

~~表示還欠了很多題目的還沒寫~~

Description:
```
Here are some encrypted messages sent to Mayday.
https://www.dropbox.com/s/lwjkboz8ee8wz6l/mayday.zip?dl=0
```

題目給的 zip 解開後有 `mayday.py` 跟 `mayday.json` 兩個檔案，同樣的，一個是算加密的 code，另一個則是相關的數字。

`mayday.json`:
```javascript
[{"c": 6867940996691870031530411714485906844552818193325528906319305401428815108346680759433216763381096732182463314446219239703961679396462026276373332783945618, "e": 7, "n": 24810910852704603048663349011054669655631146433543459534796438815331335687309113943583212235150241971378068933151593149818684880078674098193758773603399061},
{"c": 1117905220184329685115491669660129193823567641747584717324745389247133369892051586020708442213591696394252275224109800066498394464330197218398972106358012, "e": 7, "n": 47127839105299361033791208737798899776781255381503030381686909082155757361019104103280620540716894699133142173100175132195577832323495741588275138089635573},
{"c": 40118076943735337559537379692982070943921515348000211097599356263330760075906748374129727526740438883695094503103029124366037118931371140019302082751801200, "e": 7, "n": 43134291711046821358455351358884087777021003839470296505990450581706219379356272391794220129036895199873385802547302584174011929423801149992868607229780347},
{"c": 12649076592222649371192164869044025408231371717627780046219346377852024544337050152652676577122342534868958091714335614555475487488062150879916823763757293, "e": 7, "n": 19300838921149221007298944887478599082800229045219271606272038103970656559943914197281654158587468730541828306489197866130025079021184391333521894567512679},
{"c": 28899089935435267588235897519846120393433214114341521238696384122507316899457327055029546972333281452563984838498862225380416594907544057513529315866966881, "e": 7, "n": 30754121488827635692971849599267749375077949182550303145729325375314926401905783830931628738658879320179944880074582359287457299694791345311565979620527051},
{"c": 14086629413855672403639830676118042465846020320143823318815048070368505684208141652603596234960968703217788472960409410744177258293358579948872603962777501, "e": 7, "n": 30430477983470426195631142659668071772256641205525929891985872996115858010744648779370983539942187689192406517498678966428105726004485493523914299389645977},
{"c": 20049299207588955907155276095787913402589652379134151403340360498371893119855957833576443856534037886298731701974026748277461327934437483689818240109850533, "e": 7, "n": 35489275126536805974281635942907480463916089663069129771420548612817920902692423639961709000309976531819984030335085090156962285880892504720123765878938153}]
```

`mayday.json` 有了七組 RSA 數字，各自的 n （模數：modulus） 不同，其中 e （指數：public exponent）都是 7<br>
而由於 n 的數字太大（剛好也有 7 個），我們知道不可能暴力因數分解它。

`mayday.py`:
```python
import json
from sympy import randprime

e = 7
m = int(open('flag').read().strip().encode('hex'), 16)

for i in range(7):
    p = randprime(2 ** 256, 2 ** 257)
    q = randprime(2 ** 256, 2 ** 257)
    n = p * q
    assert m < n
    c = pow(m, e, n)
    print json.dumps({'n': n, 'e': e, 'c': c})
```

有趣的是，根據 `mayday.py`，所有的明文 `t` 都是一樣的，所以這樣就構成了 [Hastad's Broadcast Attack](https://en.wikipedia.org/wiki/Coppersmith%27s_Attack#H.C3.A5stad.27s_Broadcast_Attack) （廣播攻擊（？）的要件。

（Hastad's Broadcast Attack 基本上就類似[中國餘數定理](https://market.cloud.edu.tw/content/senior/math/tn_t2/math05/math_magic/1/1-6.htm)（也就是韓信點兵、鬼谷算）在 RSA 上的實做，因為多組 `cn = t^e % n` 也就等於解 `t^e ≡ cn (mod n)` （`cn` = `c1, c2, c3,...`）的同餘方程組，只要 `e` 的值不大（要可以快速求次方根；這裡是7），用中國餘數定理就可以推出原先的 `t`。）

所以我們來解同餘方程組吧！先用 [Rosetta Code 上的 CRT solver](http://rosettacode.org/wiki/Chinese_remainder_theorem#Python)：

```python
>>> from functools import reduce
>>> import gmpy
>>> import json, binascii
>>> def modinv(a, m): return int(gmpy.invert(gmpy.mpz(a), gmpy.mpz(m)))
>>> def chinese_remainder(n, a):
        sum = 0
        prod = reduce(lambda a, b: a*b, n)
        for n_i, a_i in zip(n, a):
            p = prod // n_i
            sum += a_i * modinv(p, n_i) * p
        return int(sum % prod)
>>> with open("mayday.json") as dfile:
        data = json.loads(dfile.read())
>>> data = {k:[d.get(k) for d in data] for k in {k for d in data for k in d}}
>>> t_to_e = chinese_remainder(data['n'], data['c'])
>>> t = int(gmpy.mpz(t_to_e).root(7)[0])
>>> print(binascii.unhexlify(hex(t)[2:]))
b"CTF{Hastad's Broadcast Attack & Chinese Remainder Theorem}"
...
```

Flag: `CTF{Hastad's Broadcast Attack & Chinese Remainder Theorem}`
